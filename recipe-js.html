/******** BATCH SPECIFIC VARIABLES *****/


  
 /** 
 * The TABLES object contains the string id and element by id for each table in the batch file
 * This was done so that it is easier to find and change these variables (if necessary)
 */
 var TABLES = {
    ingredient: {el: $('#recipe-ingredientTable'),
                 id:'recipe-ingredientTable',
                },
    additive: {el: $('#recipe-additiveTable'),
               id: 'recipe-additiveTable',
              },
  }
 
 
 
  /*------------------------------------------------------------------------------------*/
  /*********************************** EVENT HANDLERS ***********************************/
  /*------------------------------------------------------------------------------------*/
  


$(function(){
  
   $("#indexLoader").hide();
   getRecipeList();
   refreshSelectElements();
   createRecipeSelectEvent();
   createNewRowEventTrigger();
   createOnChangeTrigger();
   
});



/**
* Create change event trigger for recipe select
* This triggers when the user makes a selection from the recipe drop-down menu
* that is located a the top of the recipe page
*/
function createRecipeSelectEvent() {

    $('#recipeSelector').change(function() {
      
     // Get batch id from selection
      var recipeId = $('option:selected', this).attr('data-id');
      
      // Put the current recipe id into temporary storage
      memory_.currentRecipeId = recipeId;
      
      
      // If a selection is new recipe, then clear all the fields and load blank tables
      if (recipeId === 'newRecipe') {
        loadNewRecipe();
        return;
      }
      
         // show loader
      $(".fileLoadingSpinner").show();
      
      // Hide batch information
      $(".loadTable").hide();
      
      // Fetch data from server
      getRecipeData(recipeId);
      
      
    });

}




  /*-------------------------------------------------------------------------------------*/
  /***********************************    FUNCTIONS    ***********************************/
  /*-------------------------------------------------------------------------------------*/






function getRecipeList() {
   
   google.script.run.withSuccessHandler(fillrecipeSelector).getRecipeList();
}



// Fill options list for recipe select element
function fillrecipeSelector(optionsArray){
  var recipeSelector = convertOptionsArray(optionsArray,memory_.currentPage);
    
  // Append options to recipe select element
  fillHtmlSelect('#recipeSelector',recipeSelector);
  
  // According to documentation, this is supposed to enable the devices native select menu
  // It doesn't seem to work on my iPhone, but I'm going to keep it anyway.
  if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
    $('.selectpicker').selectpicker('mobile');
  }

  
  
  // Hide pre-loader
  $("#indexLoader").hide();
}




// Get batch data from server
function getRecipeData(recipeId){
  google.script.run.withSuccessHandler(processRecipeData).getRecipeData(recipeId);
}




/**
* LOAD DATA INTO TABLES
*
* Loop over the global TABLES object
* Load the table data that is associated with the specified key
*
* NOTE: The keys of the "data" JSON object in the function initializeBatchTables should have the same name as the table ids
*/
function loadTables(data){
  
  // If there is a key/value pair in data called isNewBatch, then load blank tables
  if(data.isNewRecipe) {
      for (var key in TABLES) {
          TABLES[key].el.bootstrapTable('destroy').bootstrapTable({data: ''});
      }
  } else {
      for (var key in TABLES) {
      
          TABLES[key].el.bootstrapTable('destroy').bootstrapTable({data: data[key]});
          
          
          // If there is recipe data, put the table data into a global temporary variable
          // It should be stringified to match the data coming from the server
          // which will always be stringified
          memory_.tables.recipe.tableData = data;
      }
  }
}


/**
 * Clears the batch page
 */
 function loadNewRecipe(){
 // clear all elements
  clearInputElements();
  // Get new recipe id from server
   getNewRecipeId();
   // Load tables with no data
   loadTables({isNewRecipe:true});
   // Display success message
   toast_('New batch created!','success');
 }
 
 

 
 /**
 * Get the next available batch id from the server
 *
 * return {callback function} updateRecipeSelector
 */
 function getNewRecipeId(){
   google.script.run.withSuccessHandler(updateRecipeSelector).getRecipeId();
 }

 

